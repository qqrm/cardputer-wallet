# M5Stack Cardputer Password Device v0.1 Specification

## 1. Goal

Hardware password device that types credentials over BLE HID by default and USB HID as fallback. Stores an encrypted vault in a GitHub repository. Allows local search and edit. Supports TOTP codes and macro typing.

## 2. Hardware

* Target M5Stack Cardputer ESP32 S3
* Display integrated Cardputer LCD
* Keyboard integrated Cardputer keyboard with Fn
* USB Device supported
* BLE supported
* Battery usage not a KPI for v0.1

## 3. Software stack

* Language Rust stable toolchain produced by [`espup`](https://github.com/esp-rs/espup)
* Project scaffolding created through [`esp-generate`](https://github.com/esp-rs/esp-generate) and adapted for the Cardputer
* Runtime bare metal (no RTOS)
* Concurrency [`embassy-executor`](https://github.com/embassy-rs/embassy) on the single core
* HAL [`esp-hal`](https://github.com/esp-rs/esp-hal) targeting ESP32-S3
* USB [`embassy-usb`](https://github.com/embassy-rs/embassy/tree/main/embassy-usb)
* BLE [`trouble`](https://github.com/embassy-rs/trouble) with feature gates for future mesh work
* Persistent storage [`sequential-storage`](https://github.com/tweedegolf/sequential-storage) on the external flash
* Message schema [`ergot`](https://github.com/jamesmunns/ergot) to derive codecs shared with the host
* Serialization [`postcard`](https://github.com/jamesmunns/postcard) for constrained device frames
* Crypto chacha20poly1305, x25519 dalek, ed25519 dalek, hkdf, hmac, sha2, blake3
* Secure memory zeroize with ZeroizeOnDrop

## 4. Trust model and crypto

* Device long term keypair X25519

  * Private key encrypted at rest with KEK from PIN using scrypt N 16384 r 8 p 1 len 32
  * Stored as AEAD with salt and scrypt params
* Vault symmetric key VK 32 bytes

  * Vault content encrypted with ChaCha20 Poly1305
  * Separate nonce per record page
* Recipients list

  * For each device store wrapped VK using X25519 KEM and HKDF SHA256
* Integrity

  * vault.enc and recips.json signed by project Ed25519 key
  * Public verify key built into firmware
* TOTP

  * RFC 6238 SHA1 default
  * Optional SHA256 and SHA512 per entry
  * Digits 6 default, 8 optional
  * Period 30 seconds default
* Randomness

  * ESP RNG as entropy source
  * DRBG for session keys
* Zeroization

  * PIN buffer, KEK, device private key, VK, per entry decrypted password, HKDF and AEAD work buffers, TOTP HMAC state are zeroized on use end and on lock

## 5. Lock and PIN policy

* PIN 6 to 12 digits
* 3 consecutive failures add exponential backoff
* 10 total failures trigger wipe flow that requires two key hold confirmation
* Auto lock on inactivity 90 seconds default configurable

## 6. Vault format on GitHub

* Files in repo root

  * vault.enc binary encrypted payload
  * recips.json wrapped VK recipients
  * vault.sig Ed25519 signature over vault.enc and recips.json and config.json if present
  * config.json optional unsigned content is rejected
* Encrypted payload content CBOR

  * version int
  * meta object

    * generation monotonically increasing int
    * created at, updated at UTC
  * entries array of entry objects
* Entry object

  * id uuid v4
  * title string
  * service string and optional domains array
  * username string
  * password stored inside the encrypted body, not visible in UI
  * totp optional object

    * secret base32 no spaces
    * algo sha1 or sha256 or sha512
    * digits 6 or 8
    * period seconds default 30
  * tags array of strings
  * macro optional string template
  * updated at utc, used at utc

## 7. Sync model

* v0.1 uses USB CDC to a host CLI for both pull and push
* Device side maintains an operation journal in RAM and encrypted at rest

  * ops add, update field wise, delete by id
* Push flow

  * Device sends journal frames over CDC
  * CLI applies to latest vault, resolves conflicts, re encrypts, updates recips if needed, signs, commits, pushes
  * Device clears local journal after ACK
* Pull flow

  * CLI fetches latest main, downloads signed artifacts, verifies signature locally, sends vault.enc and recips.json over CDC
  * Device verifies signature again, unwraps VK, decrypts vault, applies local unsynced ops if any
* Conflict policy last write wins by updated at per field
* Monotonic generation prevents rollback

## 8. Transport and HID

* Default BLE HID keyboard
* USB HID fallback available
* Layout US English only
* Default inter key delay 60 ms configurable 20 to 150 ms
* Between placeholders delay 120 ms default configurable
* Key up delay 20 ms default configurable
* HID runtime split into dedicated modules so BLE and USB actions can share queueing and telemetry logic

  * `firmware::hid::actions` exposes the `DeviceAction` enum (`StartSession { session_id }`, `EndSession`) and a bounded Embassy channel so sync code can enqueue work without blocking on the transport task.
  * `firmware::hid::ble` implements the shared `HidBackend` trait, the `BleHid` state machine, and the generic `HidCommandQueue` lock-free FIFO (default depth 8) that feeds transports in FIFO order.
  * `firmware::ui::transport` stores USB/BLE connectivity flags that surface in the status row so UI frames can render real-time indicators.

* `HidBackend` trait contract (shared by BLE and future USB backends)

  * `capabilities() -> IoCapabilities` describes the numeric-comparison pairing IO policy exposed to peers.
  * `process_action(DeviceAction) -> Result<HidResponse, HidError>` must advance the backend state machine, emit responses (`Connected`, `Acknowledged`, `Disconnected`), and bubble up typed errors (`AlreadyConnected`, `NoActiveSession`, `CommandQueueFull`).

### HID session state table

| State            | Triggering action (via `HidCommandQueue`)           | Resulting response      | Transport indicator effect            |
|------------------|-----------------------------------------------------|-------------------------|---------------------------------------|
| `Idle`           | n/a – reset or acknowledged session                 | `HidResponse::Disconnected` | `transport::set_ble_connected(false)` clears BLE LED |
| `Connecting`     | `DeviceAction::StartSession { session_id }` from `handle_hello` | `HidResponse::Connected { session_id }` | `transport::set_ble_connected(true)` and BLE icon lights up |
| `Streaming`      | Subsequent typing / sync commands piggy-back on active session | (implicit)             | Indicators stay steady until ACK      |
| `Awaiting ACK`   | Host applies journal, sends `Ack` frame             | `DeviceAction::EndSession` queued in `handle_ack` | `HidResponse::Acknowledged { session_id }` transitions state back to Idle and clears BLE icon |

The queue depth of 8 ensures the UI never saturates the BLE worker; overflow returns the dropped action so callers can retry or warn the user (error code 101).

### BLE and USB handshake sequences

1. **BLE start** – Host CLI issues `HELLO`, firmware increments the monotonic `session_id`, calls `DeviceAction::StartSession`, the BLE profile dequeues it, and the UI immediately shows BLE “connected”.
2. **USB link** – `cdc_server` marks USB connected once bytes are read from the CDC endpoint; transient transport failures clear `transport::set_usb_connected(false)` so the UI reflects drops.
3. **Command processing** – Sync frames continue over USB CDC while HID actions (e.g., login typing) continue to enqueue through the shared queue, guaranteeing order regardless of transport.
4. **Session close** – After the host sends `ACK`, `handle_ack` wipes sensitive material, publishes `DeviceAction::EndSession`, and the BLE backend emits `HidResponse::Acknowledged`, which also clears BLE indicators.
5. **Recovery** – Any `HidError::NoActiveSession` or CDC transport fault automatically resets the associated indicator, preventing stale “connected” UI state.

## 9. UX and UI

* Language English
* No password reveal on screen at any time
* Global states

  * Locked, Home, Entry, Edit, Settings, Sync
* Boot animations

  * Presets Ripple, Scanline, Keycaps
  * Duration 0.7 s default, 30 fps cap, can disable
* Help and hints

  * Bottom Hint bar shows active bindings
  * Holding the question key shows a cheat sheet overlay for current screen, release hides
* Search

  * Always visible on Home
  * Minimum 2 characters
  * Results sort exact prefix by service then username then fuzzy distance 1 then last used
* Home screen

  * Search input
  * Recent list
  * BLE status icon
  * Hint bar
* Entry screen

  * Header service and username
  * TOTP timer with circular progress and seconds left
  * Actions Send login, Send password, Send macro, Send OTP
  * Hint bar
* Edit screen

  * Fields title, service, username, password input masked, totp fields, tags, macro template, password generator
  * Save on Enter, Cancel on Esc
* Settings

  * Transport default BLE or USB
  * HID delays
  * Default action for Enter login or macro
  * TOTP threshold to next step 1 to 5 seconds default 3
  * Auto lock timeout
  * Brightness, theme
  * Animations on or off, preset, speed
  * Pairing policy numeric comparison required or not
  * Security secure zeroize on, wipe policy
  * Export device public key as QR

## 10. Key bindings

* Enter short type username over selected entry
* Fn Enter type password for selected entry
* Shift Enter macro for selected entry username Tab password Enter
* T type TOTP now
* If time to step change less than threshold device waits for next step then types TOTP
* B toggle BLE or USB
* S start USB sync
* Esc back, hold 2 seconds to lock
* Arrows navigate lists
* Space open entry details
* R edit entry
* Del delete entry with two step confirm

Hint bar examples

* Home [Enter] Login [Fn Enter] Password [Shift Enter] Macro [T] TOTP [?] Help
* Entry [Enter] Login [Fn Enter] Password [T] TOTP [R] Edit [S] Sync [?] Help

## 11. Macro language

* Template tokens

  * {username} {password} {totp}
  * {tab} {enter} {esc}
  * {delay:ms}
* Default macro for web {username}{tab}{password}{enter}
* Per entry template optional

## 12. Search and index

* In RAM index built at unlock
* Tokenize service, title, username, tags
* Normalize ascii lower
* Prefix table for first 3 letters points to entry ids
* Fuzzy Damerau Levenshtein distance 1 fallback
* Target 1000 entries results under 100 ms on device

## 13. TOTP behavior

* Code printed within 100 ms from trigger
* If remaining time less than threshold 3 s default device waits next period
* On screen code optional view for 5 s with countdown, masked by default with a send button
* Time source set by CLI over CDC

  * SET TIME epoch ms
  * GET TIME for diagnostics
* No NTP in v0.1

## 14. Security rules

* No password display
* PIN and key material kept only in RAM while unlocked
* On lock

  * Zeroize PIN, KEK, device private key, VK, decrypted record buffers, TOTP state, AEAD work buffers
  * Drop search index
* Constant time compare for PIN
* Flash wear leveled for secret blobs
* No telemetry
* All errors are numeric codes with short text, no stack traces
* Device validates incoming vault.enc/recips.json payloads by checking vault.sig against the embedded Ed25519 public key before
  applying updates

## 15. Config and hotkeys

* On device quick remap

  * Up to 4 actions can be remapped to 4 keys in Settings Enter macro TOTP Sync
* Repository config

  * Optional config.json stored in repo unsigned configs are ignored
  * Included in vault.sig signature scope
  * Fields

    * default enter action
    * key bindings map
    * search thresholds
    * delays
  * Device applies only if signature validates

## 16. USB CDC protocol

* Frame header

  * magic, version, command, length, payload, crc32
* Commands

  * HELLO
  * STATUS
  * SET TIME epoch ms
  * GET TIME
  * PULL HEAD returns hash and generation
  * PULL VAULT returns vault.enc and recips.json
  * PUSH VAULT streams vault.enc, recips.json, and vault.sig; device verifies the Ed25519 signature before replacing local state
  * PUSH OPS sends operation journal
  * ACK, NACK with error code

## 17. CLI responsibilities

* Verify repo signature of vault artifacts
* Resolve conflicts by per field timestamp
* Re encrypt vault
* Update recipients if requested
* Sign vault and config
* Commit and push
* Import otpauth URI and QR into entries
* Package per platform binaries Windows macOS Linux

## 18. Password generation

* Length presets 8 12 16 20 24
* Char sets upper lower digits symbols
* Exclude similar chars option
* No three identical in a row
* RNG from device entropy

## 19. Performance targets

* Unlock to Home under 300 ms
* Search 1000 entries under 100 ms
* HID typing with default delays consistent under 1 percent jitter
* TOTP print not closer than 2 s to period change unless forced by T

## 20. Power and sleep

* Manual sleep only in v0.1
* Screen brightness control
* No background Wi Fi

## 21. Firmware updates

* Manual over USB only
* Firmware image signed by project Ed25519
* Verify before apply
* Public key in firmware

## 22. Error codes

* 100 BLE not connected
* 101 HID transport busy
* 200 Vault signature invalid
* 201 Recipients missing device key
* 202 Vault generation rollback detected
* 300 PIN attempts exceeded wipe armed
* 301 Wipe confirm required
* 400 CDC protocol error
* 401 CLI rejected ops

## 23. Acceptance criteria v0.1

* PIN lock with backoff and wipe flow
* USB CDC sync round trip works pull and push
* Signature verification enforced
* Vault decrypt and list entries
* Search with 2 character minimum and correct sort
* BLE HID default typing username on Enter and password on Fn Enter
* Macro typing with Shift Enter
* TOTP generation and typing with threshold handling
* No password display on any screen
* Zeroization on lock verified by tests
* Config.json signature enforced
* Basic animations selectable

## 24. Testing

* Unit tests for crypto glue and KDF params
* RFC 6238 vectors for SHA1 6 digits period 30
* Property tests for CBOR encode decode
* CDC protocol integration tests with a loopback harness
* HID typing timing tests with host harness
* Static analysis clippy and rustfmt
* Size and stack usage checks per task

## 25. Risks and mitigations

* BLE stack maturity in no std risk

  * Provide USB HID fallback and feature gate BLE
* Keyboard ghosting on Cardputer matrix

  * Debounce and key repeat tuned
* Flash wear

  * Batch writes and journal compaction
* Time drift affects TOTP

  * Require SET TIME on each CLI session

## 26. Out of scope for v0.1

* Wi Fi pull from GitHub
* OTA updates
* Multi language UI
* Non US keyboard layouts

## 27. Roadmap

* v0.1 this spec
* v1.1 BLE HID reliability and fuzzy search distance 1
* v1.2 Wi Fi pull optional and NTP
* v1.3 CSV import and bulk edits

## 28. Open parameters with defaults

* Inter key delay 60 ms
* Placeholder delay 120 ms
* Key up delay 20 ms
* TOTP wait threshold 3 s
* Auto lock 90 s

End of spec.
