name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Run cargo fmt
        run: cargo fmt --all -- --check

  firmware_host:
    name: Firmware lint and test (host)
    runs-on: ubuntu-latest
    needs: fmt
    env:
      CARGO_REGISTRY_CACHE_KEY: ${{ runner.os }}-firmware-cargo-${{ hashFiles('**/Cargo.lock') }}
      FIRMWARE_TARGET_CACHE_KEY: ${{ runner.os }}-firmware-target-${{ hashFiles('**/Cargo.lock') }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            $HOME/.cargo/registry
            $HOME/.cargo/git
          key: ${{ env.CARGO_REGISTRY_CACHE_KEY }}

      - name: Cache firmware build artifacts
        uses: actions/cache@v4
        with:
          path: |
            target
          key: ${{ env.FIRMWARE_TARGET_CACHE_KEY }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Run cargo clippy (firmware host)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo +stable clippy --manifest-path firmware/Cargo.toml --all-targets --all-features -- -D warnings"

      - name: Run cargo test (firmware host)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo test --manifest-path firmware/Cargo.toml --target x86_64-unknown-linux-gnu"

  firmware_xtensa:
    name: Firmware Xtensa build (non-blocking)
    runs-on: ubuntu-latest
    needs: fmt
    continue-on-error: true
    env:
      CARGO_REGISTRY_CACHE_KEY: ${{ runner.os }}-firmware-cargo-${{ hashFiles('**/Cargo.lock') }}
      FIRMWARE_TARGET_CACHE_KEY: ${{ runner.os }}-firmware-target-${{ hashFiles('**/Cargo.lock') }}
      ESP_TOOLCHAIN_CACHE_KEY: ${{ runner.os }}-firmware-esp-${{ hashFiles('firmware/rust-toolchain.toml') }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            $HOME/.cargo/registry
            $HOME/.cargo/git
          key: ${{ env.CARGO_REGISTRY_CACHE_KEY }}

      - name: Cache firmware build artifacts
        uses: actions/cache@v4
        with:
          path: |
            target
          key: ${{ env.FIRMWARE_TARGET_CACHE_KEY }}

      - name: Cache ESP toolchain
        uses: actions/cache@v4
        with:
          path: |
            $HOME/.espressif
            $HOME/.rustup/toolchains/esp
            $HOME/.rustup/toolchains/nightly-esp
            $HOME/export-esp.sh
          key: ${{ env.ESP_TOOLCHAIN_CACHE_KEY }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Install espup
        run: cargo install espup

      - name: Install ESP toolchain
        run: espup install --targets esp32s3

      - name: Run cargo check (firmware Xtensa)
        continue-on-error: true
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; if [ -f \"$HOME/export-esp.sh\" ]; then source \"$HOME/export-esp.sh\"; fi; cargo +esp -Zbuild-std=core,alloc check -p firmware --target xtensa-esp32s3-none-elf"

      - name: Run cargo build (firmware Xtensa release)
        continue-on-error: true
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; if [ -f \"$HOME/export-esp.sh\" ]; then source \"$HOME/export-esp.sh\"; fi; cargo +esp -Zbuild-std=core,alloc build --release -p firmware --features firmware-bin --target xtensa-esp32s3-none-elf"

  shared:
    name: Shared lint and test
    runs-on: ubuntu-latest
    needs: fmt
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Run cargo clippy (shared)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo clippy --manifest-path shared/Cargo.toml --all-targets --all-features -- -D warnings"

      - name: Run cargo test (shared)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo test --manifest-path shared/Cargo.toml --all-features"

  host_cli:
    name: Host CLI lint and test
    runs-on: ubuntu-latest
    needs: fmt
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Run cargo clippy (host-cli)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo clippy --manifest-path host-cli/Cargo.toml --all-targets --all-features -- -D warnings"

      - name: Run cargo test (host-cli)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo test --manifest-path host-cli/Cargo.toml --all-features"
