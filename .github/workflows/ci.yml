name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Run cargo fmt
        run: cargo fmt --all -- --check

  firmware:
    name: Firmware lint and test
    runs-on: ubuntu-latest
    needs: fmt
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Install espup
        run: cargo install espup

      - name: Install ESP toolchain
        run: espup install --targets esp32s3

      - name: Select ESP toolchain
        run: rustup default esp

      - name: Install clippy component for ESP toolchain
        run: rustup +esp component add clippy

      - name: Run cargo clippy (firmware)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; if [ -f \"$HOME/export-esp.sh\" ]; then source \"$HOME/export-esp.sh\"; fi; cargo clippy --manifest-path firmware/Cargo.toml --all-targets --all-features -- -D warnings"

      - name: Run cargo check (firmware Xtensa)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; if [ -f \"$HOME/export-esp.sh\" ]; then source \"$HOME/export-esp.sh\"; fi; cargo check -p firmware --target xtensa-esp32s3-none-elf"

      - name: Run cargo build (firmware Xtensa release)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; if [ -f \"$HOME/export-esp.sh\" ]; then source \"$HOME/export-esp.sh\"; fi; cargo build --release -p firmware --features firmware-bin --target xtensa-esp32s3-none-elf"

      - name: Run cargo test (firmware host)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo test --manifest-path firmware/Cargo.toml --target x86_64-unknown-linux-gnu"

  shared:
    name: Shared lint and test
    runs-on: ubuntu-latest
    needs: fmt
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Run cargo clippy (shared)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo clippy --manifest-path shared/Cargo.toml --all-targets --all-features -- -D warnings"

      - name: Run cargo test (shared)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo test --manifest-path shared/Cargo.toml --all-features"

  host_cli:
    name: Host CLI lint and test
    runs-on: ubuntu-latest
    needs: fmt
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Run cargo clippy (host-cli)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo clippy --manifest-path host-cli/Cargo.toml --all-targets --all-features -- -D warnings"

      - name: Run cargo test (host-cli)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo test --manifest-path host-cli/Cargo.toml --all-features"
