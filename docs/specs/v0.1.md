# M5Stack Cardputer Password Device v0.1 Specification

## 1. Goal

Hardware password device that types credentials over BLE HID by default and USB HID as fallback. Stores an encrypted vault on the SD card (GitHub-backed synchronization is deliberately deferred) so operators can shuttle a single blob between the device and host CLI. Allows local search and edit. Supports TOTP codes; macro typing is now scoped as a later milestone.

### 1.1 MVP gating capabilities

These capabilities must ship before the v0.1 release can be tagged:

* PIN-gated unlock flow that unwraps the device keys before any secrets are handled.
* USB HID typing path that reliably transmits usernames, passwords, and OTP codes.
* Basic entry list with search and detail views so operators can select entries without editing tooling.
* USB CDC synchronization path that can pull and push encrypted vault blobs with signature verification.

### 1.2 Post-MVP backlog

The following experiences remain desirable, but they are explicitly post-MVP and are not blockers for v0.1:

* Boot animations, visual presets, and any cosmetic transitions beyond the static lock/home/entry flows.
* Extended settings such as per-action delay tuning, animation control, or pairing policy toggles.
* Macro language support and template-driven typing automation.
* Advanced search, fuzzy matching, or preset-driven password generators beyond the defaults enumerated below.

## 2. Hardware

* Target M5Stack Cardputer ESP32 S3
* Display integrated Cardputer LCD
* Keyboard integrated Cardputer keyboard with Fn
* USB Device supported
* BLE supported
* Battery usage not a KPI for v0.1

## 3. Software stack

* Language Rust stable toolchain produced by [`espup`](https://github.com/esp-rs/espup)
* Project scaffolding created through [`esp-generate`](https://github.com/esp-rs/esp-generate) and adapted for the Cardputer
* Runtime bare metal (no RTOS)
* Concurrency [`embassy-executor`](https://github.com/embassy-rs/embassy) on the single core
* HAL [`esp-hal`](https://github.com/esp-rs/esp-hal) targeting ESP32-S3
* USB [`embassy-usb`](https://github.com/embassy-rs/embassy/tree/main/embassy-usb)
* BLE [`trouble`](https://github.com/embassy-rs/trouble) with feature gates for future mesh work
* Persistent storage [`sequential-storage`](https://github.com/tweedegolf/sequential-storage) on the external flash
* Message schema [`ergot`](https://github.com/jamesmunns/ergot) to derive codecs shared with the host
* Serialization [`postcard`](https://github.com/jamesmunns/postcard) for constrained device frames
* Crypto chacha20poly1305, x25519 dalek, ed25519 dalek, hkdf, hmac, sha2, blake3
* Secure memory zeroize with ZeroizeOnDrop

### 3.1 Embassy-first policy

The firmware standardizes on the Embassy framework and its ecosystem crates for device peripherals, protocol stacks, and async runtimes. Contributors must source new runtime functionality (USB, BLE, executor glue, storage drivers, timers, etc.) from maintained Embassy crates whenever they exist before evaluating alternatives or custom code.

## 4. Trust model and crypto

* Device long term keypair X25519

  * Private key encrypted at rest with KEK from PIN using scrypt N 16384 r 8 p 1 len 32
  * Stored as AEAD with salt and scrypt params
* Vault symmetric key VK 32 bytes

  * Vault content encrypted with ChaCha20 Poly1305
  * Separate nonce per record page
* Recipients list

  * For each device store wrapped VK using X25519 KEM and HKDF SHA256
* Integrity

  * vault.enc and recips.json signed by project Ed25519 key
  * Public verify key built into firmware
* TOTP

  * RFC 6238 SHA1 default
  * Optional SHA256 and SHA512 per entry
  * Digits 6 default, 8 optional
  * Period 30 seconds default
* Randomness

  * ESP RNG as entropy source
  * DRBG for session keys
* Zeroization

  * PIN buffer, KEK, device private key, VK, per entry decrypted password, HKDF and AEAD work buffers, TOTP HMAC state are zeroized on use end and on lock

## 5. Lock and PIN policy

* PIN 6 to 12 digits
* 3 consecutive failures add exponential backoff
* 10 total failures trigger wipe flow that requires two key hold confirmation
* Auto lock on inactivity 90 seconds default configurable

## 6. Vault format on removable storage

* Files live on the SD card (or any removable storage copied by the host CLI). Publishing these artifacts to a Git repository remains a later-phase backlog item.

  * vault.enc binary encrypted payload
  * recips.json wrapped VK recipients
  * vault.sig Ed25519 signature over vault.enc and recips.json and config.json if present
  * config.json optional unsigned content is rejected
* Encrypted payload content CBOR

  * version int
  * meta object

    * generation monotonically increasing int
    * created at, updated at UTC
  * entries array of entry objects
* Entry object

  * id uuid v4
  * title string
  * service string and optional domains array
  * username string
  * password stored inside the encrypted body, not visible in UI
  * totp optional object

    * secret base32 no spaces
    * algo sha1 or sha256 or sha512
    * digits 6 or 8
    * period seconds default 30
  * tags array of strings
  * macro optional string template (post-MVP)
  * updated at utc, used at utc

## 7. Sync model

* v0.1 uses USB CDC to a host CLI for both pull and push
* Device side maintains an operation journal in RAM and encrypted at rest

  * ops add, update field wise, delete by id
* Push flow

  * Device sends journal frames over CDC
  * CLI applies to latest vault, resolves conflicts, re encrypts, updates recips if needed, signs, commits, pushes
  * Device clears local journal after ACK
* Pull flow

  * CLI fetches latest main, downloads signed artifacts, verifies signature locally, sends vault.enc and recips.json over CDC
  * Device verifies signature again, unwraps VK, decrypts vault, applies local unsynced ops if any
* Conflict policy last write wins by updated at per field
* Monotonic generation prevents rollback

## 8. Transport and HID

* Default BLE HID keyboard
* USB HID fallback available (USB path is the MVP baseline if BLE proves unstable)
* Layout US English only
* Default inter key delay 60 ms (custom delay tuning is post-MVP)
* Placeholder pause 120 ms default
* Key up delay 20 ms default

## 9. UX and UI

* Language English
* No password reveal on screen at any time
* Global states Locked, Home, Entry, Edit, Settings, Sync
* Search bar pinned to Home with minimum 2 characters before results are shown; results order by service then username
* Home screen shows search, the recent list, BLE/USB indicator, and lock status
* Entry screen shows service, username, and TOTP timer; actions limited to Send login, Send password, and Send OTP for v0.1
* Edit screen keeps title, service, username, password (masked), and optional TOTP configuration. Tags and macros are deferred.
* Settings exposes only transport selection, auto lock timeout, brightness, and the default Enter action. Other toggles move to Later.

## 10. Key bindings

* Enter short type username over selected entry
* Fn Enter type password for selected entry
* T type TOTP now (device waits for the next step if threshold is below 3 seconds)
* B toggle BLE or USB
* S start USB sync overlay
* Esc back, hold 2 seconds to lock
* Arrows navigate lists
* Space open entry details
* R edit entry
* Del delete entry with two step confirm

## 11. Macro language (Post-MVP)

Macro typing remains desirable for workflow automation but it is not required for the v0.1 release. The token grammar below is
retained for planning purposes and will only be implemented once the MVP ships:

* Template tokens `{username}`, `{password}`, `{totp}`, `{tab}`, `{enter}`, `{esc}`, `{delay:ms}`
* Default macro for web `{username}{tab}{password}{enter}`
* Per entry template optional

## 12. Search and index

* In RAM index built at unlock
* Tokenize service, title, username fields (tags search deferred)
* Normalize ASCII lower for prefix matching
* Prefix table for first 3 letters points to entry ids
* Fuzzy search and tag filters move to Later

## 13. TOTP behavior

* Code printed within 100 ms from trigger
* If remaining time less than threshold 3 s default device waits next period
* On screen code optional view for 5 s with countdown, masked by default with a send button
* Time source set by CLI over CDC

  * SET TIME epoch ms
  * GET TIME for diagnostics
* No NTP in v0.1

## 14. Security rules

* No password display
* PIN and key material kept only in RAM while unlocked
* On lock

  * Zeroize PIN, KEK, device private key, VK, decrypted record buffers, TOTP state, AEAD work buffers
  * Drop search index
* Constant time compare for PIN
* Flash wear leveled for secret blobs
* No telemetry
* All errors are numeric codes with short text, no stack traces
* Device validates incoming vault.enc/recips.json payloads by checking vault.sig against the embedded Ed25519 public key before
  applying updates

## 15. Config and hotkeys

* On device quick remap

* Up to 4 actions can be remapped to 4 keys in Settings (Enter login, password, TOTP, Sync). Macro remaps are post-MVP.
* Repository config

  * Optional config.json stored in repo unsigned configs are ignored
  * Included in vault.sig signature scope
  * Fields

    * default enter action
    * key bindings map
    * search thresholds
    * delays
  * Device applies only if signature validates

## 16. USB CDC protocol

* Frame header

  * magic, version, command, length, payload, crc32
* Commands

  * HELLO
  * STATUS
  * SET TIME epoch ms
  * GET TIME
  * PULL HEAD returns hash and generation
  * PULL VAULT returns vault.enc and recips.json
  * PUSH VAULT streams vault.enc, recips.json, and vault.sig; device verifies the Ed25519 signature before replacing local state
  * PUSH OPS sends operation journal
  * ACK, NACK with error code

## 17. CLI responsibilities

* Verify repo signature of vault artifacts
* Resolve conflicts by per field timestamp
* Re encrypt vault
* Update recipients if requested
* Sign vault and config
* Commit and push
* Import otpauth URI and QR into entries
* Package per platform binaries Windows macOS Linux

## 18. Password generation

* Length presets 8 12 16 20 24
* Char sets upper lower digits symbols
* Exclude similar chars option
* No three identical in a row
* RNG from device entropy

## 19. Performance targets

* Unlock to Home under 300 ms
* Search 1000 entries under 100 ms
* HID typing with default delays consistent under 1 percent jitter
* TOTP print not closer than 2 s to period change unless forced by T

## 20. Power and sleep

* Manual sleep only in v0.1
* Screen brightness control
* No background Wi Fi

## 21. Firmware updates

* Manual over USB only
* Firmware image signed by project Ed25519
* Verify before apply
* Public key in firmware

## 22. Error codes

* 100 BLE not connected
* 101 HID transport busy
* 200 Vault signature invalid
* 201 Recipients missing device key
* 202 Vault generation rollback detected
* 300 PIN attempts exceeded wipe armed
* 301 Wipe confirm required
* 400 CDC protocol error
* 401 CLI rejected ops

## 23. Acceptance criteria v0.1

* PIN lock with backoff and wipe flow; USB HID typing path must remain usable while BLE matures
* USB CDC sync round trip works pull and push with signature verification
* Vault decrypt and list entries without exposing passwords on screen
* Search with 2 character minimum and deterministic service/username ordering
* BLE HID default typing username on Enter and password on Fn Enter (USB fallback acceptable)
* TOTP generation and typing with threshold handling
* Zeroization on lock verified by tests
* Config.json signature enforced
* Post-MVP features (animations, macro typing, extended settings) do not block v0.1

## 24. Testing

* Unit tests for crypto glue and KDF params
* RFC 6238 vectors for SHA1 6 digits period 30
* Property tests for CBOR encode decode
* CDC protocol integration tests with a loopback harness
* HID typing timing tests with host harness
* Static analysis clippy and rustfmt
* Size and stack usage checks per task

## 25. Risks and mitigations

* BLE stack maturity in no std risk

  * Provide USB HID fallback and feature gate BLE
* Keyboard ghosting on Cardputer matrix

  * Debounce and key repeat tuned
* Flash wear

  * Batch writes and journal compaction
* Time drift affects TOTP

  * Require SET TIME on each CLI session

## 26. Out of scope for v0.1

* Wi Fi pull from GitHub
* OTA updates
* Multi language UI
* Non US keyboard layouts

## 27. Roadmap

* v0.1 this spec
* v1.1 BLE HID reliability and fuzzy search distance 1
* v1.2 Wi Fi pull optional and NTP
* v1.3 CSV import and bulk edits

## 28. Open parameters with defaults

* Inter key delay 60 ms
* Placeholder delay 120 ms
* Key up delay 20 ms
* TOTP wait threshold 3 s
* Auto lock 90 s

## 29. Post-MVP UX backlog

Features noted earlier as "Later" remain desirable but are out of scope for the v0.1 release plan:

* Boot animations, visual presets, and other cosmetic transitions (former ยง9 content)
* Contextual hint bars and screen overlays for help prompts
* Animation speed toggles and per-action delay customization
* Macro language implementation described in ยง11
* Tag-based search, fuzzy matching, and advanced filtering (ยง12)
* Extended settings such as pairing policy controls, QR export, and zeroize toggles

End of spec.
