name: CI

on:
  push:
    branches:
      - main
  pull_request:

env:
  RUST_TOOLCHAIN: stable
  SCCACHE_DIR: /home/runner/.cache/sccache

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Rust toolchain
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup/toolchains
            ~/.rustup/update-hashes
          key: ${{ runner.os }}-rustup-${{ env.RUST_TOOLCHAIN }}
          restore-keys: |
            ${{ runner.os }}-rustup-

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt

      - name: Run cargo fmt
        run: cargo fmt --all -- --check

  firmware_host:
    name: Firmware lint and test (host)
    runs-on: ubuntu-latest
    needs: fmt
    timeout-minutes: 40
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            $HOME/.cargo/registry
            $HOME/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache firmware build artifacts
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-target-

      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: ${{ env.SCCACHE_DIR }}
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: clippy

      - name: Install sccache
        run: cargo install sccache

      - name: Enable sccache wrapper
        run: echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"

      - name: Run cargo clippy (firmware host)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo +stable clippy --manifest-path firmware/Cargo.toml --all-targets --all-features -- -D warnings"

      - name: Run cargo test (firmware host)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo test --manifest-path firmware/Cargo.toml --target x86_64-unknown-linux-gnu"

      - name: Show sccache stats
        if: always()
        run: sccache --show-stats

  firmware_xtensa:
    name: Firmware Xtensa build (release)
    runs-on: ubuntu-latest
    needs: fmt
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            $HOME/.cargo/registry
            $HOME/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache firmware build artifacts
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-target-

      - name: Cache ESP toolchain
        uses: actions/cache@v4
        with:
          path: |
            $HOME/.espressif
            $HOME/.rustup/toolchains/esp
            $HOME/.rustup/toolchains/nightly-esp
            $HOME/export-esp.sh
          key: ${{ runner.os }}-firmware-esp-${{ hashFiles('firmware/rust-toolchain.toml') }}
          restore-keys: |
            ${{ runner.os }}-firmware-esp-

      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: ${{ env.SCCACHE_DIR }}
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: clippy

      - name: Install sccache
        run: cargo install sccache

      - name: Enable sccache wrapper
        run: echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"

      - name: Install espup
        run: cargo install espup

      - name: Install ESP toolchain
        run: espup install --targets esp32s3

      - name: Run cargo check (firmware Xtensa)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; if [ -f \"$HOME/export-esp.sh\" ]; then source \"$HOME/export-esp.sh\"; fi; cargo +esp -Zbuild-std=core,alloc check -p firmware --target xtensa-esp32s3-none-elf"

      - name: Run cargo build (firmware Xtensa release)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; if [ -f \"$HOME/export-esp.sh\" ]; then source \"$HOME/export-esp.sh\"; fi; cargo +esp -Zbuild-std=core,alloc build --release -p firmware --features firmware-bin --target xtensa-esp32s3-none-elf"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: cardputer-firmware-xtensa
          path: target/xtensa-esp32s3-none-elf/release/cardputer-firmware
          retention-days: 14

      - name: Show sccache stats
        if: always()
        run: sccache --show-stats

  shared:
    name: Shared lint and test
    runs-on: ubuntu-latest
    needs: fmt
    timeout-minutes: 40
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            $HOME/.cargo/registry
            $HOME/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache shared build artifacts
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-target-

      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: ${{ env.SCCACHE_DIR }}
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: clippy

      - name: Install sccache
        run: cargo install sccache

      - name: Enable sccache wrapper
        run: echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"

      - name: Run cargo clippy (shared)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo clippy --manifest-path shared/Cargo.toml --all-targets --all-features -- -D warnings"

      - name: Run cargo test (shared)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo test --manifest-path shared/Cargo.toml --all-features"

      - name: Show sccache stats
        if: always()
        run: sccache --show-stats

  host_cli:
    name: Host CLI lint and test
    runs-on: ubuntu-latest
    needs: fmt
    timeout-minutes: 40
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            $HOME/.cargo/registry
            $HOME/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache host-cli build artifacts
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-target-

      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: ${{ env.SCCACHE_DIR }}
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: clippy

      - name: Install sccache
        run: cargo install sccache

      - name: Enable sccache wrapper
        run: echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"

      - name: Run cargo clippy (host-cli)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo clippy --manifest-path host-cli/Cargo.toml --all-targets --all-features -- -D warnings"

      - name: Run cargo test (host-cli)
        run: >-
          bash -lc "set -euo pipefail; if [ -f \"$HOME/.cargo/env\" ]; then source \"$HOME/.cargo/env\"; fi; cargo test --manifest-path host-cli/Cargo.toml --all-features"

      - name: Show sccache stats
        if: always()
        run: sccache --show-stats
