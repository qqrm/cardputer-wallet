# Firmware crate

This crate hosts the Cardputer wallet firmware logic that runs on the **ESP32-S3**. The project now follows the layout generated by [`esp-generate`](https://github.com/esp-rs/esp-generate) so that it can be rebuilt easily with new toolchain releases while keeping the existing protocol and UI code.

## Layout overview

- `.cargo/config.toml` pins the Xtensa target (`xtensa-esp32s3-none-elf`) and wires `espflash` as the default runner.
- `src/lib.rs` and `src/ui/` contain the previously implemented protocol stack, storage routines, and UI state machine.
- `src/bin/main.rs` provides the asynchronous entry point generated by `esp-generate`. It is gated behind the `firmware-bin` feature so that host-side builds can focus on the library code.

## Building

### Host (library + tests)

The crypto, storage, and protocol layers remain fully testable on the development machine:

```bash
cargo test -p firmware
```

### Firmware image for ESP32-S3

1. Install the Espressif Xtensa toolchain by following the [official guide](https://docs.espressif.com/projects/rust/book/getting-started/toolchain.html#xtensa-devices). The quick setup is:

   ```bash
   cargo install espup
   espup install --targets esp32s3
   source "$HOME/.cargo/env"
   source "$HOME/export-esp.sh"
   cargo install espflash
   ```

2. Build the firmware binary with the `firmware-bin` feature enabled:

   ```bash
   cargo build --release -p firmware --features firmware-bin --target xtensa-esp32s3-none-elf
   ```

   The `.cargo/config.toml` file automatically selects the Xtensa target when you work inside the crate directory.

3. Flash the resulting image with `espflash` (adjust the serial port to match your device):

   ```bash
   espflash flash target/xtensa-esp32s3-none-elf/release/cardputer-firmware
   ```

## Regenerating the scaffold

Whenever the Espressif tooling introduces a new best-practice layout, regenerate the project in place:

```bash
esp-generate cardputer-firmware \
  -c esp32s3 \
  --headless \
  --option alloc \
  --option embassy \
  --option ble-trouble \
  --option unstable-hal \
  --option esp-backtrace \
  --option log \
  --output-path firmware
```

After regeneration, copy the existing `src/lib.rs` and `src/ui/` tree back into the template and verify `firmware/Cargo.toml` keeps the required dependency versions (`esp-hal`, `embassy-executor`, `trouble-host`, `sequential-storage`).
